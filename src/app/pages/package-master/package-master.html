<div>
  @if (isShowAlert()) {
  <app-alert-box [isShowSuccess]="isSuccessAlert()" [alertReq]="alertObj()"></app-alert-box>
  }

  <div class="row">
    <div class="col">
      <div class="card shadow-premium border-0 h-100">
        <div #insideHeader class="card-header-premium d-flex justify-content-between align-items-center">
          <div class="header-content">
            <h3><i class="bi bi-box-seam me-2"></i> Package Management</h3>
          </div>
          <div class="col-md-3">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" class="form-control" placeholder="Enter Package name" [(ngModel)]="searchText"
                (ngModelChange)="onSearch()">
            </div>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <button class="btn btn-outline-dark" [title]="isShowCardView() ? 'Show Table View' : 'Show Card View'"
              (click)="isShowCardView() ? toggleView(false) : toggleView(true)">
              <i class="bi" [ngClass]="{'bi-toggles2': isShowCardView(), 'bi-toggles' :!isShowCardView()}"></i>
            </button> &nbsp;&nbsp;
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
              data-bs-target="#addPackageModal">
              <i class="bi bi-plus-lg me-2"></i> Add Package
            </button>
          </div>
        </div>

        <div class="packages-container">
          <div class="list-viewport">
            @if (isPackageLoading()) {
            <div class="loading-container">
              <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading packages...</p>
              </div>
            </div>
            }
            @if (!isPackageLoading()) {
            @if (filterdPackageList().length == 0) {
            <div class="empty-state">
              <div class="empty-state-icon">
                <i class="bi bi-inbox"></i>
              </div>
              <h4 class="empty-state-title">No Packages Yet</h4>
              <p class="empty-state-text">Get started by creating your first package</p>
              <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addPackageModal">
              </button>
            </div>
            }
            @if (filterdPackageList().length) {
            @if (!isShowCardView()) {
            <table class="table table-bordered table-hover">
              <thead class="table-primary">
                <tr>
                  <th></th>
                  <th>Name</th>
                  <th>One Time Fees</th>
                  <th>EMI</th>
                  <th>Total Branches</th>
                  <th>Total Students</th>
                  <th>SMS Alert</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (pkg of filterdPackageList(); track pkg.packageId) {
                <tr>
                  <td>{{$index + 1}}</td>
                  <td>{{pkg.packageName}}</td>
                  <td>{{pkg.oneTimeTotalCost}}</td>
                  <td>{{pkg.emiTotalCost}}</td>
                  <td>{{pkg.maxBranches}}</td>
                  <td>{{pkg.maxStudents}}</td>
                  <td>
                    <span class="feature-content">
                      <span class="feature-badge" [class.badge-success]="pkg.isSmsAlert"
                        [class.badge-danger]="!pkg.isSmsAlert">
                        {{ pkg.isSmsAlert ? 'Enabled' : 'Disabled' }}
                      </span>
                    </span>
                  </td>
                  <td class="g-2 branch-card-footer" style="display: flex; justify-content: space-between;">
                    <button class="btn-action btn-edit" data-bs-toggle="modal" data-bs-target="#addPackageModal"
                      (click)="editPackage(pkg)">
                      <i class="bi bi-pencil-square"></i>
                      <span>Edit</span>
                    </button> &nbsp;&nbsp;
                    <button class="btn-action btn-delete" (click)="deletePackage(pkg.packageId)">
                      <i class="bi bi-trash-fill"></i>
                      <span>Delete</span>
                    </button>
                  </td>
                </tr>
                }
              </tbody>
            </table>
            } @else {
            <div class="row g-3">
              @for (pkg of filterdPackageList(); track pkg.packageId) {
              <div class="col-xl-3 col-lg-4 col-md-4">
                <div class="card package-card-modern h-100">
                  <div class="card-header text-center">
                    <h5 class="package-name">{{ pkg.packageName }}</h5>
                  </div>
                  <div class="card-body d-flex flex-column">
                    <div class="package-card-body">
                      <div class="features-section">
                        <div class="feature-item">
                          <i class="bi bi-currency-rupee feature-icon"></i>
                          <div class="feature-content">
                            <span class="feature-label">One-Time</span>
                            <span class="feature-value">{{ pkg.oneTimeTotalCost }}</span>
                          </div>
                        </div>
                        <div class="feature-item">
                          <i class="bi bi-currency-rupee feature-icon"></i>
                          <div class="feature-content">
                            <span class="feature-label">EMI</span>
                            <span class="feature-value">{{ pkg.emiTotalCost }}</span>
                          </div>
                        </div>
                        <div class="feature-item">
                          <i class="bi bi-building feature-icon"></i>
                          <div class="feature-content">
                            <span class="feature-label">Total Branches</span>
                            <span class="feature-value">{{ pkg.maxBranches }}</span>
                          </div>
                        </div>
                        <div class="feature-item">
                          <i class="bi bi-people-fill feature-icon"></i>
                          <div class="feature-content">
                            <span class="feature-label">Total Students</span>
                            <span class="feature-value">{{ pkg.maxStudents }}</span>
                          </div>
                        </div>
                        <div class="feature-item">
                          <i class="bi bi-chat-dots-fill feature-icon"></i>
                          <div class="feature-content">
                            <span class="feature-label">SMS Alert</span>
                            <span class="feature-badge" [class.badge-success]="pkg.isSmsAlert"
                              [class.badge-danger]="!pkg.isSmsAlert">
                              {{ pkg.isSmsAlert ? 'Enabled' : 'Disabled' }}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="package-card-footer mt-auto">
                      <button class="btn-action btn-edit" data-bs-toggle="modal" data-bs-target="#addPackageModal"
                        (click)="editPackage(pkg)">
                        <i class="bi bi-pencil-square"></i>
                        <span>Edit</span>
                      </button>
                      <button class="btn-action btn-delete" (click)="deletePackage(pkg.packageId)">
                        <i class="bi bi-trash-fill"></i>
                        <span>Delete</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              }
            </div>
            }
            }
            }
          </div>
        </div>

        <div #paginationContainer style="padding: 0 10px;">
          <!-- Right-aligned -->
          <ul class="pagination justify-content-end">
            @for (page of pagination.pageNumbers; track page) {
            <li class="page-item" [class.disabled]="currentPageNo() === page || filteredSearchText()">
              <a class="page-link" style="cursor: pointer;" (click)="goToPage(page)">{{ page }}</a>
            </li>
            }
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Modal for Add / Update Package -->
<div class="modal fade modal-xl" id="addPackageModal" data-bs-backdrop="static" tabindex="-1" role="dialog"
  aria-labelledby="addPackageModalModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-modern">
      <form [formGroup]="packageForm" (ngSubmit)="createPackage()">
        <div class="modal-header modal-header-modern">
          <div>
            <h5 class="modal-title" id="addPackageModalLabel">
              <i class="bi me-2" [ngClass]="{
                  'bi-plus-circle-fill': !pacakgeMasterId,
                  'bi-pencil-square': pacakgeMasterId
                }"></i>
              {{ pacakgeMasterId ? 'Update' : 'Add New' }} Package
            </h5>
            <p class="modal-subtitle mb-0">
              {{
              pacakgeMasterId
              ? 'Modify package details'
              : 'Fill in the details to create a new package'
              }}
            </p>
          </div>
          <button type="button" class="btn-close-modern" data-bs-dismiss="modal" aria-label="Close"
            (click)="cancelEdit()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div class="modal-body modal-body-modern">
          <div class="form-section">
            <!-- <h6 class="section-title"><i class="bi bi-info-circle me-2"></i>Basic Information</h6> -->
            <div class="row g-3">
              <div class="col-6">
                <div class="form-group-modern">
                  <label class="form-label-modern">
                    <i class="bi bi-tag me-2"></i>Package Name
                  </label>
                  <input type="text" class="form-control-modern" formControlName="packageName"
                    placeholder="e.g., Premium Plan, Enterprise Suite" />
                </div>
              </div>
              <div class="col-6">
                <!-- <h6 class="section-title"><i class="bi bi-toggles me-2"></i>Features</h6> -->
                <div class="form-check-modern">
                  <input class="form-check-input-modern" type="checkbox" formControlName="isSmsAlert" id="smsAlert" />
                  <label class="form-check-label-modern" for="smsAlert">
                    <i class="bi bi-chat-dots me-2"></i>Enable SMS Alert Notifications
                    <small class="d-block text-muted mt-1">Students will receive SMS notifications for important
                      updates</small>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <!-- <h6 class="section-title"><i class="bi bi-currency-rupee me-2"></i>Pricing Details</h6> -->
            <div class="row g-3">
              <div class="col-md-6">
                <div class="form-group-modern">
                  <label class="form-label-modern">One Time Total Cost</label>
                  <div class="input-group-modern">
                    <span class="input-group-text">₹</span>
                    <input type="number" class="form-control-modern" formControlName="oneTimeTotalCost"
                      placeholder="0" />
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group-modern">
                  <label class="form-label-modern">EMI Total Cost</label>
                  <div class="input-group-modern">
                    <span class="input-group-text">₹</span>
                    <input type="text" class="form-control-modern" formControlName="emiTotalCost" placeholder="0" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <!-- <h6 class="section-title"><i class="bi bi-sliders me-2"></i>Capacity Limits</h6> -->
            <div class="row g-3">
              <div class="col-md-6">
                <div class="form-group-modern">
                  <label class="form-label-modern">
                    <i class="bi bi-building me-2"></i>Maximum Branches
                  </label>
                  <input type="number" class="form-control-modern" formControlName="maxBranches" placeholder="0" />
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group-modern">
                  <label class="form-label-modern">
                    <i class="bi bi-people me-2"></i>Maximum Students
                  </label>
                  <input type="number" class="form-control-modern" formControlName="maxStudents" placeholder="0" />
                </div>
              </div>
            </div>
          </div>
        </div>


        <div class="modal-footer modal-footer-modern">
          @if (isAddUpdatePkgLoader()) {
          <div class="modal-loading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 mb-0">Processing...</p>
          </div>
          }
          @if (pacakgeMasterId) {
          <button class="btn btn-cancel-modern" [disabled]="isAddUpdatePkgLoader()" type="button"
            (click)="cancelEdit()">
            <i class="bi bi-x-circle me-2"></i>Cancel
          </button>
          }
          <button class="btn btn-submit-modern" [disabled]="packageForm.invalid || isAddUpdatePkgLoader()"
            [ngClass]="{ 'btn-update': pacakgeMasterId }" type="submit">
            <i class="bi me-2" [ngClass]="{
                'bi-plus-circle-fill': !pacakgeMasterId,
                'bi-check-circle-fill': pacakgeMasterId
              }"></i>
            {{ pacakgeMasterId ? 'Update Package' : 'Create Package' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>